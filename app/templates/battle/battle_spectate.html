{% extends "layouts/base.html" %}

{% block title %}Spectating: Battle for {{ battle.region.name }} - Tactizen{% endblock %}

{% block head_extra %}
{% include '_dashboard_styles.html' %}
<style>
    .battle-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    .battle-main-section {
        background: url('/static/images/battle.png') center top / cover no-repeat;
        border-radius: 16px;
        position: relative;
        margin-bottom: 1.5rem;
    }

    .battle-main-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0.65) 100%);
        border-radius: 16px;
    }

    .spectator-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        z-index: 10;
        background: rgba(139, 92, 246, 0.3);
        border: 2px solid #8b5cf6;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        color: #a78bfa;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .spectator-badge i {
        margin-right: 0.5rem;
    }

    .battle-header {
        padding: 1rem 2rem 0.5rem 2rem;
        text-align: center;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        z-index: 1;
    }

    .battle-actions {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
        display: flex;
        gap: 0.5rem;
    }

    .battle-actions .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }

    .battle-header > * {
        position: relative;
    }

    .battle-title {
        font-size: 2rem;
        font-weight: 700;
        color: #ffffff;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
        margin-bottom: 0.5rem;
    }

    .battle-subtitle {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.1rem;
    }

    .country-flags {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .country-flags img {
        height: 28px;
        border-radius: 4px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .country-flags .vs {
        color: rgba(255, 255, 255, 0.6);
        font-weight: 700;
    }

    .battle-stats-inline {
        display: flex;
        justify-content: center;
        gap: 1rem;
        padding: 0.25rem 2rem 0.5rem 2rem;
        position: relative;
        z-index: 1;
        flex-wrap: wrap;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(0, 0, 0, 0.4);
        padding: 0.3rem 0.8rem;
        border-radius: 8px;
        min-width: 60px;
    }

    .stat-label {
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
    }

    .stat-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: #ffffff;
    }

    .walls-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        padding: 0.5rem 2rem 1rem 2rem;
        position: relative;
        z-index: 1;
    }

    .wall-card {
        background: rgba(15, 20, 30, 0.7);
        backdrop-filter: blur(4px);
        border-radius: 12px;
        border: 2px solid rgba(100, 116, 139, 0.3);
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
    }

    .wall-card.aviation { border-left: 4px solid #8b5cf6; }
    .wall-card.armoured { border-left: 4px solid #f59e0b; }
    .wall-card.infantry { border-left: 4px solid #3b82f6; }

    .wall-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .wall-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #ffffff;
    }

    .wall-name i {
        margin-right: 0.5rem;
    }

    .wall-name.aviation i { color: #8b5cf6; }
    .wall-name.armoured i { color: #f59e0b; }
    .wall-name.infantry i { color: #3b82f6; }

    .wall-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .wall-side {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 140px;
    }

    .wall-side.defender {
        align-items: flex-start;
    }

    .wall-side.attacker {
        align-items: flex-end;
    }

    .wall-side-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .wall-side.defender .wall-side-label { color: #22c55e; }
    .wall-side.attacker .wall-side-label { color: #dc2626; }

    .top-fighter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
    }

    .wall-side.attacker .top-fighter {
        flex-direction: row-reverse;
    }

    .top-fighter-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
        object-fit: cover;
        background: rgba(0, 0, 0, 0.3);
    }

    .wall-side.defender .top-fighter-avatar {
        border-color: #22c55e;
    }

    .wall-side.attacker .top-fighter-avatar {
        border-color: #dc2626;
    }

    .top-fighter-info {
        display: flex;
        flex-direction: column;
    }

    .wall-side.attacker .top-fighter-info {
        text-align: right;
    }

    .top-fighter-name {
        font-size: 0.8rem;
        color: #ffffff;
        font-weight: 500;
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .top-fighter-damage {
        font-size: 0.75rem;
        font-weight: 700;
    }

    .wall-side.defender .top-fighter-damage { color: #22c55e; }
    .wall-side.attacker .top-fighter-damage { color: #dc2626; }

    .wall-progress-section {
        flex: 1;
    }

    .progress-bar-container {
        height: 24px;
        background: linear-gradient(90deg, rgba(34, 197, 94, 0.2) 0%, rgba(100, 116, 139, 0.1) 50%, rgba(220, 38, 38, 0.2) 100%);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-indicator {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 3px;
        background: #ffffff;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2;
    }

    .progress-fill {
        position: absolute;
        top: 0;
        bottom: 0;
        transition: all 0.3s ease;
    }

    .progress-fill.attacker {
        background: linear-gradient(90deg, transparent, #dc2626);
        right: 50%;
    }

    .progress-fill.defender {
        background: linear-gradient(270deg, transparent, #22c55e);
        left: 50%;
    }

    .damage-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
    }

    .damage-labels .defender { color: #22c55e; }
    .damage-labels .attacker { color: #dc2626; }

    /* Spectator-specific styling */
    .join-battle-section {
        padding: 1rem 2rem 1.5rem 2rem;
        position: relative;
        z-index: 1;
        text-align: center;
    }

    .join-battle-btn {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        color: #ffffff;
        border: none;
        padding: 0.75rem 2.5rem;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.3s ease;
    }

    .join-battle-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
        color: #ffffff;
    }

    .cannot-fight-message {
        background: rgba(100, 116, 139, 0.2);
        border: 1px solid rgba(100, 116, 139, 0.3);
        padding: 1rem 2rem;
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.7);
        display: inline-block;
    }

    .cannot-fight-message i {
        margin-right: 0.5rem;
    }

    /* Participant stats */
    .participants-section {
        padding: 1rem 2rem 1.5rem 2rem;
        position: relative;
        z-index: 1;
    }

    .participants-row {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .participant-stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
    }

    .participant-stat.attacker {
        border-left: 3px solid #dc2626;
    }

    .participant-stat.defender {
        border-left: 3px solid #22c55e;
    }

    .participant-stat .count {
        font-size: 1.2rem;
        font-weight: 700;
    }

    .participant-stat.attacker .count { color: #dc2626; }
    .participant-stat.defender .count { color: #22c55e; }

    .participant-stat .label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
    }

    /* Live feed */
    .live-feed-section {
        background: rgba(15, 20, 30, 0.9);
        border-radius: 12px;
        border: 1px solid rgba(100, 116, 139, 0.2);
        padding: 1rem;
        margin-top: 1rem;
    }

    .live-feed-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }

    .live-feed-header h5 {
        color: #ffffff;
        margin: 0;
        font-size: 1rem;
    }

    .live-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: #22c55e;
    }

    .live-dot {
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    .feed-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .feed-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        background: rgba(0, 0, 0, 0.2);
    }

    .feed-item:last-child {
        margin-bottom: 0;
    }

    .feed-item.attacker {
        border-left: 3px solid #dc2626;
    }

    .feed-item.defender {
        border-left: 3px solid #22c55e;
    }

    .feed-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
    }

    .feed-info {
        flex: 1;
    }

    .feed-username {
        font-size: 0.85rem;
        color: #ffffff;
    }

    .feed-wall {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .feed-damage {
        font-weight: 700;
        font-size: 0.9rem;
    }

    .feed-item.attacker .feed-damage { color: #dc2626; }
    .feed-item.defender .feed-damage { color: #22c55e; }

    /* Constructions info */
    .constructions-info {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        padding: 0.5rem 2rem 1rem 2rem;
        position: relative;
        z-index: 1;
    }

    .construction-badge {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .construction-badge.fortress {
        background: rgba(139, 92, 246, 0.2);
        border: 1px solid rgba(139, 92, 246, 0.4);
        color: #a78bfa;
    }

    .construction-badge.hospital {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #f87171;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .battle-container {
            padding: 0.5rem;
        }

        .battle-header {
            padding: 0.75rem 1rem 0.5rem 1rem;
        }

        .battle-title {
            font-size: 1.4rem;
            padding-right: 100px;
        }

        .walls-container {
            padding: 0.5rem 0.75rem 0.75rem 0.75rem;
        }

        .wall-content {
            flex-direction: column;
            gap: 0.5rem;
        }

        .wall-side {
            flex-direction: row;
            width: 100%;
            justify-content: flex-start;
            min-width: unset;
        }

        .wall-side.attacker {
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .wall-side-label {
            display: none;
        }

        .join-battle-btn {
            padding: 0.6rem 1.5rem;
            font-size: 1rem;
        }
    }

    @media (max-width: 480px) {
        .wall-side {
            display: none;
        }

        .battle-title {
            font-size: 1.1rem;
        }

        .spectator-badge {
            position: static;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .battle-actions {
            position: static;
            justify-content: center;
            margin-top: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block main_layout %}
{% include '_dashboard_wrapper.html' %}

<div class="battle-container">
    <div class="battle-main-section">
        <!-- Spectator Badge -->
        <div class="spectator-badge">
            <i class="fas fa-eye"></i> Spectating
        </div>

        <!-- Battle Actions (top right) -->
        <div class="battle-actions">
            <a href="{{ url_for('main.battles_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list"></i><span class="d-none d-md-inline"> All Battles</span>
            </a>
            <a href="{{ url_for('main.war_detail', war_id=battle.war_id) }}" class="btn btn-outline-info">
                <i class="fas fa-flag"></i><span class="d-none d-md-inline"> View War</span>
            </a>
        </div>

        <div class="battle-header">
            <h1 class="battle-title">
                <i class="fas fa-crosshairs"></i> Battle for {{ battle.region.name }}
            </h1>
            <p class="battle-subtitle">
                {{ battle.war.attacker_country.name }} vs {{ battle.war.defender_country.name }}
            </p>
            <div class="country-flags">
                {% if battle.war.attacker_country.flag_code %}
                <img src="{{ url_for('static', filename='images/country-flags/' + battle.war.attacker_country.flag_code + '.png') }}"
                     alt="{{ battle.war.attacker_country.name }}" title="{{ battle.war.attacker_country.name }}">
                {% endif %}
                <span class="vs">VS</span>
                {% if battle.war.defender_country.flag_code %}
                <img src="{{ url_for('static', filename='images/country-flags/' + battle.war.defender_country.flag_code + '.png') }}"
                     alt="{{ battle.war.defender_country.name }}" title="{{ battle.war.defender_country.name }}">
                {% endif %}
            </div>
        </div>

        <!-- Battle Stats -->
        <div class="battle-stats-inline">
            <div class="stat-item">
                <span class="stat-label">Round</span>
                <span class="stat-value">{{ battle.current_round }}/3</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Attacker</span>
                <span class="stat-value text-danger" id="attacker-wins">{{ battle.attacker_rounds_won }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Defender</span>
                <span class="stat-value text-success" id="defender-wins">{{ battle.defender_rounds_won }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Round</span>
                <span class="stat-value" id="round-timer" style="color: #f59e0b;">--:--:--</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Battle</span>
                <span class="stat-value" id="battle-timer" style="color: #dc2626;">--:--:--</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Fighters</span>
                <span class="stat-value" id="total-fighters">{{ total_participants }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total DMG</span>
                <span class="stat-value" id="total-damage">{{ "{:,.0f}".format(total_damage) }}</span>
            </div>
        </div>

        <!-- Three Walls -->
        <div class="walls-container">
            <!-- Aviation Wall -->
            <div class="wall-card aviation" id="wall-aviation">
                <div class="wall-header">
                    <span class="wall-name aviation"><i class="fas fa-helicopter"></i> Aviation</span>
                </div>
                <div class="wall-content">
                    <div class="wall-side defender">
                        <div class="wall-side-label"><i class="fas fa-shield-alt"></i> Defenders</div>
                        {% for entry in leaderboards.get('aviation', {}).get('defender', [])[:3] %}
                        <div class="top-fighter">
                            <img src="{{ entry.avatar_url or url_for('static', filename='images/default_avatar_placeholder.png') }}" alt="" class="top-fighter-avatar">
                            <div class="top-fighter-info">
                                <span class="top-fighter-name">{{ entry.username }}</span>
                                <span class="top-fighter-damage">{{ entry.total_damage|int }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="wall-progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-indicator"></div>
                            {% set progress = wall_progress.get('aviation', {}).get('progress', 0) %}
                            {% if progress > 0 %}
                            <div class="progress-fill attacker" style="width: {{ (progress / 2)|abs }}%;"></div>
                            {% elif progress < 0 %}
                            <div class="progress-fill defender" style="width: {{ (progress / 2)|abs }}%;"></div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="wall-side attacker">
                        <div class="wall-side-label">Attackers <i class="fas fa-crosshairs"></i></div>
                        {% for entry in leaderboards.get('aviation', {}).get('attacker', [])[:3] %}
                        <div class="top-fighter">
                            <img src="{{ entry.avatar_url or url_for('static', filename='images/default_avatar_placeholder.png') }}" alt="" class="top-fighter-avatar">
                            <div class="top-fighter-info">
                                <span class="top-fighter-name">{{ entry.username }}</span>
                                <span class="top-fighter-damage">{{ entry.total_damage|int }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Armoured Wall -->
            <div class="wall-card armoured" id="wall-armoured">
                <div class="wall-header">
                    <span class="wall-name armoured"><i class="fas fa-tank"></i> Armoured</span>
                </div>
                <div class="wall-content">
                    <div class="wall-side defender">
                        <div class="wall-side-label"><i class="fas fa-shield-alt"></i> Defenders</div>
                        {% for entry in leaderboards.get('armoured', {}).get('defender', [])[:3] %}
                        <div class="top-fighter">
                            <img src="{{ entry.avatar_url or url_for('static', filename='images/default_avatar_placeholder.png') }}" alt="" class="top-fighter-avatar">
                            <div class="top-fighter-info">
                                <span class="top-fighter-name">{{ entry.username }}</span>
                                <span class="top-fighter-damage">{{ entry.total_damage|int }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="wall-progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-indicator"></div>
                            {% set progress = wall_progress.get('armoured', {}).get('progress', 0) %}
                            {% if progress > 0 %}
                            <div class="progress-fill attacker" style="width: {{ (progress / 2)|abs }}%;"></div>
                            {% elif progress < 0 %}
                            <div class="progress-fill defender" style="width: {{ (progress / 2)|abs }}%;"></div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="wall-side attacker">
                        <div class="wall-side-label">Attackers <i class="fas fa-crosshairs"></i></div>
                        {% for entry in leaderboards.get('armoured', {}).get('attacker', [])[:3] %}
                        <div class="top-fighter">
                            <img src="{{ entry.avatar_url or url_for('static', filename='images/default_avatar_placeholder.png') }}" alt="" class="top-fighter-avatar">
                            <div class="top-fighter-info">
                                <span class="top-fighter-name">{{ entry.username }}</span>
                                <span class="top-fighter-damage">{{ entry.total_damage|int }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Infantry Wall -->
            <div class="wall-card infantry" id="wall-infantry">
                <div class="wall-header">
                    <span class="wall-name infantry"><i class="fas fa-user-friends"></i> Infantry</span>
                </div>
                <div class="wall-content">
                    <div class="wall-side defender">
                        <div class="wall-side-label"><i class="fas fa-shield-alt"></i> Defenders</div>
                        {% for entry in leaderboards.get('infantry', {}).get('defender', [])[:3] %}
                        <div class="top-fighter">
                            <img src="{{ entry.avatar_url or url_for('static', filename='images/default_avatar_placeholder.png') }}" alt="" class="top-fighter-avatar">
                            <div class="top-fighter-info">
                                <span class="top-fighter-name">{{ entry.username }}</span>
                                <span class="top-fighter-damage">{{ entry.total_damage|int }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="wall-progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-indicator"></div>
                            {% set progress = wall_progress.get('infantry', {}).get('progress', 0) %}
                            {% if progress > 0 %}
                            <div class="progress-fill attacker" style="width: {{ (progress / 2)|abs }}%;"></div>
                            {% elif progress < 0 %}
                            <div class="progress-fill defender" style="width: {{ (progress / 2)|abs }}%;"></div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="wall-side attacker">
                        <div class="wall-side-label">Attackers <i class="fas fa-crosshairs"></i></div>
                        {% for entry in leaderboards.get('infantry', {}).get('attacker', [])[:3] %}
                        <div class="top-fighter">
                            <img src="{{ entry.avatar_url or url_for('static', filename='images/default_avatar_placeholder.png') }}" alt="" class="top-fighter-avatar">
                            <div class="top-fighter-info">
                                <span class="top-fighter-name">{{ entry.username }}</span>
                                <span class="top-fighter-damage">{{ entry.total_damage|int }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Regional Constructions Info -->
        {% if hospital_info or fortress_info %}
        <div class="constructions-info">
            {% if fortress_info %}
            <div class="construction-badge fortress">
                <i class="fas fa-chess-rook"></i>
                <span>Fortress Q{{ fortress_info.quality }}</span>
                <small>({{ fortress_info.damage_reduction }}% DEF bonus)</small>
            </div>
            {% endif %}
            {% if hospital_info %}
            <div class="construction-badge hospital">
                <i class="fas fa-hospital"></i>
                <span>Hospital Q{{ hospital_info.quality }}</span>
                <small>(+{{ hospital_info.wellness_restore }} HP)</small>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Participant Stats -->
        <div class="participants-section">
            <div class="participants-row">
                <div class="participant-stat defender">
                    <span class="count" id="defender-count">{{ defender_participants }}</span>
                    <span class="label">Defenders</span>
                </div>
                <div class="participant-stat attacker">
                    <span class="count" id="attacker-count">{{ attacker_participants }}</span>
                    <span class="label">Attackers</span>
                </div>
            </div>
        </div>

        <!-- Join Battle Section -->
        <div class="join-battle-section">
            {% if can_fight %}
            <a href="{{ url_for('main.battle_screen', battle_id=battle.id) }}" class="join-battle-btn">
                <i class="fas fa-fist-raised"></i>
                Join Battle as {% if is_attacker %}Attacker{% else %}Defender{% endif %}!
            </a>
            {% else %}
            <div class="cannot-fight-message">
                <i class="fas fa-info-circle"></i>
                {{ side_message }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Live Damage Feed -->
    <div class="live-feed-section">
        <div class="live-feed-header">
            <h5><i class="fas fa-bolt me-2 text-warning"></i>Live Damage Feed</h5>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
        </div>
        <div class="feed-list" id="damage-feed">
            {% for d in recent_damage %}
            <div class="feed-item {% if d.is_attacker %}attacker{% else %}defender{% endif %}">
                <img src="{{ d.user.avatar_url or url_for('static', filename='images/default_avatar_placeholder.png') }}" alt="" class="feed-avatar">
                <div class="feed-info">
                    <span class="feed-username">{{ d.user.username or d.user.wallet_address[:8] }}</span>
                    <span class="feed-wall">{{ d.wall_type.value|capitalize }}</span>
                </div>
                <span class="feed-damage">+{{ d.damage|int }}</span>
            </div>
            {% else %}
            <div class="text-center text-muted py-3" id="no-damage-message">
                <i class="fas fa-hourglass-half me-2"></i> Waiting for combat activity...
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% include '_dashboard_wrapper_end.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Timer variables
    let roundEndsAt = {% if current_round and current_round.ends_at %}new Date('{{ current_round.ends_at.isoformat() }}Z'){% else %}null{% endif %};
    let battleEndsAt = {% if battle.ends_at %}new Date('{{ battle.ends_at.isoformat() }}Z'){% else %}null{% endif %};
    const defaultAvatar = "{{ url_for('static', filename='images/default_avatar_placeholder.png') }}";

    function formatTime(ms) {
        if (ms <= 0) return '00:00:00';
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateTimers() {
        const now = new Date();

        let battleDiff = 0;
        if (battleEndsAt) {
            battleDiff = battleEndsAt - now;
            document.getElementById('battle-timer').textContent = formatTime(battleDiff);
        }

        if (roundEndsAt) {
            let roundDiff = roundEndsAt - now;
            if (battleEndsAt && roundDiff > battleDiff) {
                roundDiff = battleDiff;
            }
            document.getElementById('round-timer').textContent = formatTime(roundDiff);
        }
    }

    updateTimers();
    setInterval(updateTimers, 1000);

    // Function to update wall leaderboards
    function updateWallLeaderboards(leaderboards) {
        for (const [wallType, sides] of Object.entries(leaderboards)) {
            const card = document.getElementById('wall-' + wallType);
            if (!card) continue;

            // Update defender side
            const defenderSide = card.querySelector('.wall-side.defender');
            if (defenderSide) {
                const existingFighters = defenderSide.querySelectorAll('.top-fighter');
                existingFighters.forEach(f => f.remove());

                sides.defender.forEach(entry => {
                    const fighter = document.createElement('div');
                    fighter.className = 'top-fighter';
                    fighter.innerHTML = `
                        <img src="${entry.avatar || defaultAvatar}" alt="" class="top-fighter-avatar">
                        <div class="top-fighter-info">
                            <span class="top-fighter-name">${entry.username}</span>
                            <span class="top-fighter-damage">${Math.floor(entry.damage).toLocaleString()}</span>
                        </div>
                    `;
                    defenderSide.appendChild(fighter);
                });
            }

            // Update attacker side
            const attackerSide = card.querySelector('.wall-side.attacker');
            if (attackerSide) {
                const existingFighters = attackerSide.querySelectorAll('.top-fighter');
                existingFighters.forEach(f => f.remove());

                sides.attacker.forEach(entry => {
                    const fighter = document.createElement('div');
                    fighter.className = 'top-fighter';
                    fighter.innerHTML = `
                        <img src="${entry.avatar || defaultAvatar}" alt="" class="top-fighter-avatar">
                        <div class="top-fighter-info">
                            <span class="top-fighter-name">${entry.username}</span>
                            <span class="top-fighter-damage">${Math.floor(entry.damage).toLocaleString()}</span>
                        </div>
                    `;
                    attackerSide.appendChild(fighter);
                });
            }
        }
    }

    // Update damage feed
    function updateDamageFeed(recentDamage) {
        const feedList = document.getElementById('damage-feed');
        const noMessage = document.getElementById('no-damage-message');

        if (recentDamage.length > 0 && noMessage) {
            noMessage.remove();
        }

        // Clear and rebuild feed (showing most recent first)
        feedList.innerHTML = '';
        recentDamage.forEach(d => {
            const item = document.createElement('div');
            item.className = 'feed-item ' + (d.is_attacker ? 'attacker' : 'defender');
            item.innerHTML = `
                <img src="${d.avatar || defaultAvatar}" alt="" class="feed-avatar">
                <div class="feed-info">
                    <span class="feed-username">${d.username}</span>
                    <span class="feed-wall">${d.wall_type.charAt(0).toUpperCase() + d.wall_type.slice(1)}</span>
                </div>
                <span class="feed-damage">+${Math.floor(d.damage).toLocaleString()}</span>
            `;
            feedList.appendChild(item);
        });
    }

    // Auto-refresh every 3 seconds
    setInterval(function() {
        fetch('{{ url_for("main.battle_spectate_status", battle_id=battle.id) }}')
            .then(response => response.json())
            .then(data => {
                // Update wall progress bars
                for (const [wall, status] of Object.entries(data.wall_progress)) {
                    const card = document.getElementById('wall-' + wall);
                    if (card) {
                        const container = card.querySelector('.progress-bar-container');
                        const existingFill = container.querySelector('.progress-fill');
                        if (existingFill) existingFill.remove();

                        const progress = status.progress;
                        if (progress !== 0) {
                            const fill = document.createElement('div');
                            fill.className = 'progress-fill ' + (progress > 0 ? 'attacker' : 'defender');
                            fill.style.width = Math.abs(progress / 2) + '%';
                            container.appendChild(fill);
                        }
                    }
                }

                // Update leaderboards
                if (data.leaderboards) {
                    updateWallLeaderboards(data.leaderboards);
                }

                // Update damage feed
                if (data.recent_damage) {
                    updateDamageFeed(data.recent_damage);
                }

                // Update round wins
                document.getElementById('attacker-wins').textContent = data.attacker_rounds_won;
                document.getElementById('defender-wins').textContent = data.defender_rounds_won;

                // Update participant counts
                document.getElementById('attacker-count').textContent = data.attacker_participants;
                document.getElementById('defender-count').textContent = data.defender_participants;

                // Update timers from server
                if (data.round_ends_at) {
                    roundEndsAt = new Date(data.round_ends_at);
                }
                if (data.ends_at) {
                    battleEndsAt = new Date(data.ends_at);
                }

                // Redirect if battle ended
                if (data.battle_status !== 'active') {
                    window.location.href = '{{ url_for("main.war_detail", war_id=battle.war_id) }}';
                }
            })
            .catch(error => console.error('Spectator update error:', error));
    }, 3000);
});
</script>
{% endblock %}
