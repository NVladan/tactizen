{% extends "layouts/base.html" %}

{% block app_content %}
<div class="admin-container">
    <h2><i class="fas fa-gem"></i> Regional Resources</h2>
    <p class="text-muted">Manage natural resource deposits in regions. Resources deplete as companies extract them.</p>
    <hr>

    {# --- Add Resource Form --- #}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add Resource Deposit</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin.add_regional_resource') }}" class="row g-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="col-md-4">
                    <label for="region_id" class="form-label">Region</label>
                    <select class="form-select" id="region_id" name="region_id" required>
                        <option value="">Select region...</option>
                        {% for region in regions %}
                        <option value="{{ region.id }}">{{ region.name }} ({{ region.current_owner.name if region.current_owner else 'Unclaimed' }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="resource_id" class="form-label">Resource</label>
                    <select class="form-select" id="resource_id" name="resource_id" required>
                        <option value="">Select resource...</option>
                        {% for resource in extractable_resources %}
                        <option value="{{ resource.id }}">{{ resource.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="amount" class="form-label">Amount</label>
                    <input type="number" class="form-control" id="amount" name="amount" min="1" placeholder="e.g., 10000" required>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# --- Filters --- #}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="country" class="form-label">Country</label>
                    <select class="form-select" id="country" name="country">
                        <option value="">All countries</option>
                        {% for country in countries %}
                        <option value="{{ country.id }}" {% if country_filter == country.id %}selected{% endif %}>
                            {{ country.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="resource" class="form-label">Resource</label>
                    <select class="form-select" id="resource" name="resource">
                        <option value="">All resources</option>
                        {% for resource in extractable_resources %}
                        <option value="{{ resource.id }}" {% if resource_filter == resource.id %}selected{% endif %}>
                            {{ resource.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="show_depleted" class="form-label">Show Depleted</label>
                    <select class="form-select" id="show_depleted" name="show_depleted">
                        <option value="no" {% if show_depleted != 'yes' %}selected{% endif %}>Hide depleted</option>
                        <option value="yes" {% if show_depleted == 'yes' %}selected{% endif %}>Show all</option>
                    </select>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search"></i> Filter
                    </button>
                    <a href="{{ url_for('admin.regional_resources') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear
                    </a>
                </div>
            </form>
        </div>
    </div>

    {# --- Resources Table --- #}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-list"></i> Resource Deposits ({{ regional_resources|length }})</h5>
        </div>
        <div class="card-body p-0">
            {% if regional_resources %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Region</th>
                            <th>Country</th>
                            <th>Resource</th>
                            <th>Amount</th>
                            <th>Initial</th>
                            <th>Remaining</th>
                            <th>Added By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for deposit in regional_resources %}
                        <tr class="{% if deposit.is_depleted %}table-danger{% elif deposit.remaining_percentage < 25 %}table-warning{% endif %}">
                            <td>
                                <a href="{{ url_for('main.region', slug=deposit.region.slug) }}">
                                    {{ deposit.region.name }}
                                </a>
                            </td>
                            <td>
                                {% set owner = deposit.region.current_owner %}
                                {% if owner %}
                                <a href="{{ url_for('main.country', slug=owner.slug) }}">
                                    {% if owner.flag_code %}
                                    <img src="{{ url_for('static', filename='images/country-flags/' + owner.flag_code + '.png') }}"
                                         alt="{{ owner.name }}" width="20" class="me-1">
                                    {% endif %}
                                    {{ owner.name }}
                                </a>
                                {% else %}
                                <span class="text-muted">Unclaimed</span>
                                {% endif %}
                            </td>
                            <td>
                                <img src="{{ url_for('static', filename='images/resources/' + deposit.resource.slug + '.png') }}"
                                     alt="{{ deposit.resource.name }}" width="24" class="me-1">
                                {{ deposit.resource.name }}
                            </td>
                            <td>
                                <strong class="{% if deposit.is_depleted %}text-danger{% elif deposit.amount < 1000 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "{:,}".format(deposit.amount) }}
                                </strong>
                            </td>
                            <td class="text-muted">{{ "{:,}".format(deposit.initial_amount) }}</td>
                            <td>
                                <div class="progress" style="height: 20px; min-width: 100px;">
                                    <div class="progress-bar {% if deposit.remaining_percentage > 50 %}bg-success{% elif deposit.remaining_percentage > 25 %}bg-warning{% else %}bg-danger{% endif %}"
                                         role="progressbar"
                                         style="width: {{ deposit.remaining_percentage }}%">
                                        {{ "%.1f"|format(deposit.remaining_percentage) }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if deposit.added_by %}
                                <a href="{{ url_for('main.view_profile', username=deposit.added_by.username) }}">
                                    {{ deposit.added_by.username }}
                                </a>
                                {% else %}
                                <span class="text-muted">System</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {# Edit button with inline form #}
                                    <button type="button" class="btn btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal{{ deposit.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    {# Delete form #}
                                    <form method="POST" action="{{ url_for('admin.delete_regional_resource', deposit_id=deposit.id) }}"
                                          class="d-inline"
                                          onsubmit="return confirm('Delete {{ deposit.resource.name }} from {{ deposit.region.name }}?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-outline-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>

                                {# Edit Modal #}
                                <div class="modal fade" id="editModal{{ deposit.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form method="POST" action="{{ url_for('admin.edit_regional_resource', deposit_id=deposit.id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">
                                                        Edit {{ deposit.resource.name }} in {{ deposit.region.name }}
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="amount{{ deposit.id }}" class="form-label">Amount</label>
                                                        <input type="number" class="form-control"
                                                               id="amount{{ deposit.id }}"
                                                               name="amount"
                                                               value="{{ deposit.amount }}"
                                                               min="0" required>
                                                    </div>
                                                    <p class="text-muted small">
                                                        Initial amount: {{ "{:,}".format(deposit.initial_amount) }}<br>
                                                        Currently: {{ "{:,}".format(deposit.amount) }} ({{ "%.1f"|format(deposit.remaining_percentage) }}% remaining)
                                                    </p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="fas fa-gem fa-3x mb-3" style="opacity: 0.3;"></i>
                <p>No resource deposits found.</p>
                <p>Use the form above to add resources to regions.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('admin.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Admin Dashboard
        </a>
    </div>
</div>

<style>
    .admin-container {
        padding: 2rem 0;
    }
    .progress {
        background-color: rgba(255,255,255,0.1);
    }
</style>
{% endblock %}
