{% extends "layouts/base.html" %}

{% block app_content %}
<div class="admin-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2"><i class="fas fa-exclamation-triangle"></i> Suspicious Activity</h1>
        <a href="{{ url_for('admin.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Admin
        </a>
    </div>

    <div class="alert alert-warning mb-4">
        <i class="fas fa-shield-alt me-2"></i>
        <strong>Anti-Cheat Detection:</strong> This page automatically flags potential exploiters, multi-accounters, and suspicious wealth accumulation.
        Review each alert and take action if necessary.
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4">
        {% set high_count = alerts|selectattr('severity', 'equalto', 'high')|list|length %}
        {% set medium_count = alerts|selectattr('severity', 'equalto', 'medium')|list|length %}
        {% set low_count = alerts|selectattr('severity', 'equalto', 'low')|list|length %}
        <div class="col-md-3">
            <div class="card bg-dark border-danger">
                <div class="card-body text-center">
                    <h5 class="text-danger"><i class="fas fa-exclamation-circle"></i> High Severity</h5>
                    <h2 class="text-danger">{{ high_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-warning">
                <div class="card-body text-center">
                    <h5 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Medium Severity</h5>
                    <h2 class="text-warning">{{ medium_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-info">
                <div class="card-body text-center">
                    <h5 class="text-info"><i class="fas fa-info-circle"></i> Low Severity</h5>
                    <h2 class="text-info">{{ low_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-secondary">
                <div class="card-body text-center">
                    <h5 class="text-secondary"><i class="fas fa-list"></i> Total Alerts</h5>
                    <h2>{{ alerts|length }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts List -->
    {% if alerts %}
    <div class="alerts-container">
        {% for alert in alerts %}
        <div class="card mb-3 alert-card alert-{{ alert.severity }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    {% if alert.severity == 'high' %}
                        <span class="badge bg-danger me-2"><i class="fas fa-exclamation-circle"></i> HIGH</span>
                    {% elif alert.severity == 'medium' %}
                        <span class="badge bg-warning text-dark me-2"><i class="fas fa-exclamation-triangle"></i> MEDIUM</span>
                    {% else %}
                        <span class="badge bg-info me-2"><i class="fas fa-info-circle"></i> LOW</span>
                    {% endif %}

                    {% if alert.type == 'duplicate_ip' %}
                        <span class="badge bg-secondary"><i class="fas fa-network-wired"></i> Duplicate IP</span>
                    {% elif alert.type == 'rapid_wealth' %}
                        <span class="badge bg-secondary"><i class="fas fa-chart-line"></i> Rapid Wealth</span>
                    {% elif alert.type == 'wealthy_newbie' %}
                        <span class="badge bg-secondary"><i class="fas fa-user-plus"></i> Wealthy New Account</span>
                    {% elif alert.type == 'many_companies' %}
                        <span class="badge bg-secondary"><i class="fas fa-building"></i> Many Companies</span>
                    {% endif %}
                </div>
                <small class="text-muted">{{ alert.description }}</small>
            </div>
            <div class="card-body">
                {% if alert.type == 'duplicate_ip' %}
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>IP Address:</strong> <code class="text-warning">{{ alert.ip }}</code></p>
                            <p><strong>Account Count:</strong> {{ alert.account_count }}</p>
                            <p><strong>Combined Gold:</strong> <span class="text-warning">{{ "{:,.2f}".format(alert.total_gold) }}</span></p>
                            <p><strong>Combined Currency:</strong> <span class="text-info">{{ "{:,.2f}".format(alert.total_currency) }}</span></p>
                        </div>
                        <div class="col-md-8">
                            <p><strong>Accounts:</strong></p>
                            <div class="table-responsive">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Username</th>
                                            <th>Gold</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in alert.users %}
                                        <tr>
                                            <td>{{ user.id }}</td>
                                            <td>{{ user.username or user.wallet_address[:10] }}</td>
                                            <td class="text-warning">{{ "{:,.2f}".format(user.gold|float) }}</td>
                                            <td><small>{{ user.created_at.strftime('%Y-%m-%d') }}</small></td>
                                            <td>
                                                <a href="{{ url_for('admin.user_activity', user_id=user.id) }}" class="btn btn-xs btn-info" title="Activity">
                                                    <i class="fas fa-chart-line"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                {% elif alert.type == 'rapid_wealth' %}
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>User:</strong>
                                <a href="{{ url_for('admin.user_activity', user_id=alert.user.id) }}" class="text-info">
                                    {{ alert.user.username or alert.user.wallet_address[:10] }}
                                </a>
                            </p>
                            <p><strong>Gold Gained (24h):</strong> <span class="text-warning">+{{ "{:,.2f}".format(alert.amount_gained) }}</span></p>
                            <p><strong>Current Gold:</strong> <span class="text-warning">{{ "{:,.2f}".format(alert.user.gold|float) }}</span></p>
                            <p><strong>Last IP:</strong> <code>{{ alert.user.last_ip or 'N/A' }}</code></p>
                        </div>
                        <div class="col-md-8">
                            <p><strong>Recent Transactions:</strong></p>
                            <div class="table-responsive">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tx in alert.recent_transactions %}
                                        <tr>
                                            <td><small>{{ tx.timestamp.strftime('%H:%M:%S') }}</small></td>
                                            <td><code>{{ tx.transaction_type }}</code></td>
                                            <td class="text-warning">{{ "{:,.2f}".format(tx.amount|float) }}</td>
                                            <td><small>{{ tx.description or '-' }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                {% elif alert.type == 'wealthy_newbie' %}
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>User:</strong>
                                <a href="{{ url_for('admin.user_activity', user_id=alert.user.id) }}" class="text-info">
                                    {{ alert.user.username or alert.user.wallet_address[:10] }}
                                </a>
                            </p>
                            <p><strong>Gold:</strong> <span class="text-warning">{{ "{:,.2f}".format(alert.gold) }}</span></p>
                            <p><strong>Account Age:</strong> {{ alert.account_age_days }} days</p>
                            <p><strong>Last IP:</strong> <code>{{ alert.user.last_ip or 'N/A' }}</code></p>
                            <p><strong>Created:</strong> {{ alert.user.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-secondary">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Tip:</strong> Check if this IP has other accounts, review transaction history for suspicious patterns.
                            </div>
                            <a href="{{ url_for('admin.wealth_investigation', tab='players', search=alert.user.last_ip) }}" class="btn btn-sm btn-warning">
                                <i class="fas fa-search"></i> Search Same IP
                            </a>
                            <a href="{{ url_for('admin.transaction_monitor', type='player', hours=168) }}" class="btn btn-sm btn-info">
                                <i class="fas fa-exchange-alt"></i> View All Transactions
                            </a>
                        </div>
                    </div>

                {% elif alert.type == 'many_companies' %}
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>User:</strong>
                                <a href="{{ url_for('admin.user_activity', user_id=alert.user.id) }}" class="text-info">
                                    {{ alert.user.username or alert.user.wallet_address[:10] }}
                                </a>
                            </p>
                            <p><strong>Company Count:</strong> {{ alert.company_count }}</p>
                            <p><strong>Total Company Gold:</strong> <span class="text-warning">{{ "{:,.2f}".format(alert.total_company_gold) }}</span></p>
                            <p><strong>Personal Gold:</strong> <span class="text-warning">{{ "{:,.2f}".format(alert.user.gold|float) }}</span></p>
                        </div>
                        <div class="col-md-8">
                            <p><strong>Companies Owned:</strong></p>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Gold</th>
                                            <th>Currency</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for company in alert.companies %}
                                        <tr>
                                            <td>{{ company.name }}</td>
                                            <td><small>{{ company.company_type.value }}</small></td>
                                            <td class="text-warning">{{ "{:,.2f}".format(company.gold_balance|float) }}</td>
                                            <td class="text-info">{{ "{:,.2f}".format(company.currency_balance|float) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
            <h4>No Suspicious Activity Detected</h4>
            <p class="text-muted">The system has not detected any potential exploits or multi-accounting.</p>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .admin-container {
        padding: 2rem 0;
    }

    .alert-card {
        background: #1a1f2e;
        border-left: 4px solid;
    }

    .alert-card.alert-high {
        border-left-color: #ef4444;
    }

    .alert-card.alert-medium {
        border-left-color: #f59e0b;
    }

    .alert-card.alert-low {
        border-left-color: #3b82f6;
    }

    .alert-card .card-header {
        background: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-dark {
        margin-bottom: 0;
    }

    .table-dark th {
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 0.85rem;
    }

    .table-dark td {
        font-size: 0.9rem;
        vertical-align: middle;
    }

    .btn-xs {
        padding: 0.15rem 0.4rem;
        font-size: 0.75rem;
    }
</style>
{% endblock %}
