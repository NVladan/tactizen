{% extends "layouts/base.html" %}

{% block app_content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="fas fa-chart-line"></i> Activity Dashboard</h2>
            <p class="text-muted">Real-time user activity monitoring and statistics</p>
            <hr>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Activity Tracking:</strong> This dashboard shows real-time user activity and engagement metrics.
                <a href="{{ url_for('admin.activity_logs') }}" class="alert-link">View detailed activity logs</a>
            </div>

            <!-- Quick Stats -->
            <h3>Overview (Past 24 Hours)</h3>
            <div class="row mt-4 mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h5 class="card-title">Online Now</h5>
                            <h2 class="text-success">{{ online_count }}</h2>
                            <small class="text-muted">Active in last 5 min</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Users</h5>
                            <h2 class="text-primary">{{ total_users }}</h2>
                            <small class="text-muted">Registered accounts</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h5 class="card-title">Logins (24h)</h5>
                            <h2 class="text-info">{{ total_logins_24h }}</h2>
                            <small class="text-muted">Past 24 hours</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h5 class="card-title">Activity Types</h5>
                            <h2 class="text-warning">{{ activity_stats|length }}</h2>
                            <small class="text-muted">Unique actions</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currently Online Users -->
            <h3>Currently Online Users</h3>
            <div class="card mb-4">
                <div class="card-body">
                    {% if online_users %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Last Seen</th>
                                        <th>Total Logins</th>
                                        <th>Page Views</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in online_users %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-circle text-success" style="font-size: 8px;"></i>
                                            {{ user.username or user.wallet_address[:10] + '...' }}
                                        </td>
                                        <td>
                                            {% if user.last_seen %}
                                                {{ user.last_seen.strftime('%Y-%m-%d %H:%M:%S') }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>{{ user.login_count or 0 }}</td>
                                        <td>{{ user.page_views or 0 }}</td>
                                        <td>
                                            <a href="{{ url_for('admin.user_activity', user_id=user.id) }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i> View Activity
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted"><i class="fas fa-info-circle"></i> No users currently online.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Activity Breakdown -->
            <h3>Activity Breakdown (Past 24 Hours)</h3>
            <div class="card mb-4">
                <div class="card-body">
                    {% if activity_stats %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Activity Type</th>
                                        <th>Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity_type, count in activity_stats %}
                                    <tr>
                                        <td>
                                            <strong>{{ activity_type.value|upper|replace('_', ' ') }}</strong>
                                        </td>
                                        <td><span class="badge bg-primary">{{ count }}</span></td>
                                        <td>
                                            <a href="{{ url_for('admin.activity_logs', type=activity_type.value) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-list"></i> View Logs
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted"><i class="fas fa-info-circle"></i> No activity in the past 24 hours.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Most Active Users -->
            <h3>Most Active Users (Past 7 Days)</h3>
            <div class="card mb-4">
                <div class="card-body">
                    {% if most_active %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>User</th>
                                        <th>Activity Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_id, username, activity_count in most_active %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ username or 'User #' + user_id|string }}</td>
                                        <td><span class="badge bg-success">{{ activity_count }}</span></td>
                                        <td>
                                            <a href="{{ url_for('admin.user_activity', user_id=user_id) }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i> View Details
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted"><i class="fas fa-info-circle"></i> No activity data available for the past 7 days.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-4">
                <a href="{{ url_for('admin.activity_logs') }}" class="btn btn-primary">
                    <i class="fas fa-list"></i> View All Activity Logs
                </a>
                <a href="{{ url_for('admin.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Admin Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
