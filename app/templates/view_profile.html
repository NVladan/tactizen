{% extends "layouts/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_extra %}
{% include '_dashboard_styles.html' %}
<style>
/* Profile Layout - Competition Style */
.profile-layout {
    display: flex;
    gap: 1.5rem;
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
}

/* Left Sidebar */
.profile-sidebar {
    width: 280px;
    flex-shrink: 0;
}

.profile-main {
    flex: 1;
    min-width: 0;
}

/* Avatar Card */
.avatar-card {
    background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
}

.avatar-wrapper {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 0 auto 1rem;
}

.avatar-image {
    width: 100%;
    height: 100%;
    border-radius: 12px;
    object-fit: cover;
    border: 3px solid rgba(34, 197, 94, 0.3);
    background: #0a0e1a;
}

.online-indicator {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 3px solid #1a1f2e;
}

.online-indicator.online {
    background: #22c55e;
    box-shadow: 0 0 10px #22c55e;
}

.online-indicator.offline {
    background: #6b7280;
}

.avatar-username {
    font-size: 1.25rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.25rem;
}

.avatar-level {
    display: inline-block;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    margin-bottom: 0.5rem;
}

.online-status-text {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
}

.online-status-text.online {
    color: #22c55e;
}

/* Info Card */
.info-card {
    background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.info-card-header {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.info-row {
    display: flex;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.85rem;
    min-width: 90px;
}

.info-value {
    color: #fff;
    font-size: 0.9rem;
}

.info-value a {
    color: #22c55e;
    text-decoration: none;
}

.info-value a:hover {
    text-decoration: underline;
}

.flag-icon {
    width: 20px;
    height: 14px;
    border: 1px solid #555;
    margin-right: 0.5rem;
    vertical-align: middle;
}

/* Party Card */
.party-card {
    background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.party-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.party-header i {
    color: #fbbf24;
}

.party-name {
    color: #22c55e;
    font-weight: 600;
}

.party-role {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
}

/* Military Unit Card */
.mu-card {
    background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}

/* Main Content Area */
.profile-header-bar {
    background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
}

.profile-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.profile-title h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #fff;
    margin: 0;
}

.profile-title .level-badge {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: #fff;
    font-size: 1rem;
    font-weight: 700;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
}

.profile-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.profile-actions .btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
}

/* Tab Navigation */
.profile-tabs {
    background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    margin-bottom: 1rem;
    overflow: visible;
}

.tab-nav {
    display: flex;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    overflow-x: auto;
}

.tab-btn {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    padding: 1rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    border-bottom: 3px solid transparent;
    margin-bottom: -1px;
}

.tab-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.05);
}

.tab-btn.active {
    color: #22c55e;
    border-bottom-color: #22c55e;
    background: rgba(34, 197, 94, 0.05);
}

.tab-content {
    padding: 1.5rem;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

/* Section Headers */
.section-header {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Military Attributes Grid */
.military-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.military-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.military-card-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0.75rem;
}

.military-card-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #22c55e;
}

.military-rank-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.rank-image-box {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
    border: 2px solid rgba(251, 191, 36, 0.3);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rank-image-box img {
    width: 50px;
    height: 50px;
    object-fit: contain;
}

.rank-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fbbf24;
}

.rank-bonus {
    font-size: 0.85rem;
    color: #22c55e;
}

/* XP Progress */
.xp-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.xp-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.xp-label {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.6);
}

.xp-value {
    font-size: 0.85rem;
    color: #22c55e;
    font-weight: 600;
}

.xp-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.xp-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.xp-bar-fill.rank {
    background: linear-gradient(90deg, #fbbf24, #f59e0b);
}

/* Skills Grid */
.skills-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.skill-category {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
}

.skill-category-header {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.skill-category-header.military {
    color: #ef4444;
}

.skill-category-header.work {
    color: #3b82f6;
}

.skill-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.4rem 0;
    gap: 0.5rem;
}

.skill-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    object-fit: cover;
}

.skill-name {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
    flex: 1;
}

.skill-value {
    font-weight: 600;
    font-size: 0.85rem;
}

.skill-value.military {
    color: #ef4444;
}

.skill-value.work {
    color: #3b82f6;
}

/* Achievements Grid */
.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
}

.achievement-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
}

.achievement-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 215, 0, 0.5);
    box-shadow: 0 8px 20px rgba(255, 215, 0, 0.15);
}

.achievement-image {
    width: 80px;
    height: 80px;
    margin: 0 auto 0.75rem;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid rgba(255, 215, 0, 0.4);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
}

.achievement-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.achievement-name {
    font-weight: 600;
    color: #fff;
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

.achievement-category {
    font-size: 0.7rem;
    color: rgba(255, 215, 0, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
}

.achievement-desc {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.5rem;
    display: none;
}

.achievement-footer {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.75rem;
}

.achievement-reward {
    color: #fbbf24;
    font-weight: 600;
}

.achievement-date {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.7rem;
}

/* Friends Grid */
.friends-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.friend-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem;
    text-decoration: none;
    transition: all 0.2s;
}

.friend-card:hover {
    border-color: rgba(34, 197, 94, 0.3);
    background: rgba(34, 197, 94, 0.05);
}

.friend-avatar {
    width: 45px;
    height: 45px;
    border-radius: 8px;
    object-fit: cover;
}

.friend-name {
    font-weight: 600;
    color: #fff;
    font-size: 0.9rem;
}

.friend-level {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
}

/* NFT Slots */
.nft-slots-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.nft-slot-card {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(15, 20, 25, 0.8) 100%);
    border: 2px solid rgba(34, 197, 94, 0.2);
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.nft-slot-card:hover {
    border-color: rgba(34, 197, 94, 0.4);
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.15);
}

.nft-slot-card.empty {
    border-style: dashed;
}

/* Allow hover zoom to escape container */
.nft-slot-card,
.nft-slot-content,
.equipped-nft-card {
    overflow: visible;
}

.nft-slot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.nft-slot-number {
    font-weight: 700;
    font-size: 1.1rem;
    color: #22c55e;
}

.nft-slot-cooldown {
    font-size: 0.8rem;
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
}

.nft-slot-content {
    min-height: 280px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.nft-slot-actions {
    margin-top: 0.75rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: rgba(255, 255, 255, 0.4);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state p {
    margin-bottom: 0.5rem;
}

/* About Section */
.about-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.about-text {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    line-height: 1.6;
    white-space: pre-wrap;
}

/* Equipped NFT Card */
.equipped-nft-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    width: 100%;
}

.equipped-nft-image {
    width: 140px;
    height: 240px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid rgba(34, 197, 94, 0.3);
    background: #0a0e1a;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.equipped-nft-image:hover {
    transform: scale(1.5);
    z-index: 100;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), 0 0 20px rgba(34, 197, 94, 0.4);
}

.equipped-nft-info {
    width: 100%;
}

.equipped-nft-name {
    font-weight: 700;
    font-size: 1rem;
    color: #fff;
    margin-bottom: 0.5rem;
}

.equipped-nft-bonus {
    color: #22c55e;
    font-size: 1rem;
    font-weight: 600;
    background: rgba(34, 197, 94, 0.15);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    display: inline-block;
}

/* NFT Selection Modal - Grid Layout */
.nft-select-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    overflow: visible;
}

.nft-select-card {
    background: #1a1f2e;
    border: 2px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 160px;
    flex-shrink: 0;
    position: relative;
    overflow: visible;
}

.nft-select-card:hover {
    border-color: rgba(34, 197, 94, 0.5);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.25);
    z-index: 100;
}

.nft-select-card.selected {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
}

.nft-select-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.nft-select-image {
    position: relative;
    margin-bottom: 0.75rem;
    text-align: center;
}

/* NFT card image - matches marketplace style exactly */
.nft-select-image img {
    width: 140px;
    height: 240px;
    object-fit: cover;
    border-radius: 12px;
    border: 2px solid rgba(34, 197, 94, 0.3);
    background: #0a0e1a;
    display: inline-block;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

/* Hover zoom effect - same as marketplace */
.nft-select-image img:hover {
    transform: scale(2);
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), 0 0 20px rgba(34, 197, 94, 0.4);
}

/* Allow zoomed images to escape modal boundaries */
#equipNFTModal .modal-dialog {
    overflow: visible !important;
}

#equipNFTModal .modal-content {
    overflow: visible !important;
}

#equipNFTModal .modal-body {
    overflow: visible !important;
    overflow-y: visible !important;
}

#nft-selection-container {
    overflow: visible !important;
}

.nft-select-grid {
    overflow: visible !important;
}

.nft-select-card {
    overflow: visible !important;
}

.nft-select-inner {
    overflow: visible !important;
}

.nft-select-image .nft-placeholder {
    width: 140px;
    height: 240px;
    background: rgba(34, 197, 94, 0.1);
    border: 2px dashed rgba(34, 197, 94, 0.3);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(34, 197, 94, 0.4);
    font-size: 2rem;
}

.nft-select-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
}

.nft-tier-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.75rem;
    color: #fff;
}

.nft-tier-badge.tier-1 { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
.nft-tier-badge.tier-2 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.nft-tier-badge.tier-3 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.nft-tier-badge.tier-4 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
.nft-tier-badge.tier-5 { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

.nft-bonus-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.7rem;
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.nft-select-name {
    font-weight: 600;
    color: #fff;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

/* Responsive */
@media (max-width: 992px) {
    .profile-layout {
        flex-direction: column;
    }

    .profile-sidebar {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .avatar-card {
        grid-column: 1 / -1;
    }

    .skills-section {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .profile-layout {
        padding: 0.5rem;
        gap: 1rem;
    }

    .profile-header-bar {
        padding: 1rem;
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
    }

    .profile-title {
        flex-direction: column;
        gap: 0.5rem;
    }

    .profile-title h1 {
        font-size: 1.4rem;
    }

    .profile-actions {
        justify-content: center;
        width: 100%;
    }

    .profile-actions .btn {
        flex: 1;
        min-width: 100px;
    }

    .tab-nav {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    .tab-nav::-webkit-scrollbar {
        display: none;
    }

    .tab-btn {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .tab-content {
        padding: 1rem;
    }

    .military-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .military-card {
        padding: 0.75rem;
    }

    .military-rank-display {
        flex-direction: column;
        gap: 0.5rem;
    }

    .achievements-grid {
        grid-template-columns: 1fr;
    }

    .friends-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }

    .nft-slots-grid {
        grid-template-columns: 1fr;
    }

    .avatar-wrapper {
        width: 140px;
        height: 140px;
    }

    .info-card, .party-card, .mu-card {
        padding: 0.75rem;
    }
}

@media (max-width: 480px) {
    .profile-layout {
        padding: 0.25rem;
    }

    .profile-sidebar {
        grid-template-columns: 1fr;
    }

    .profile-header-bar {
        padding: 0.75rem;
    }

    .profile-title h1 {
        font-size: 1.2rem;
    }

    .profile-title .level-badge {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }

    .profile-actions {
        flex-direction: column;
        gap: 0.5rem;
    }

    .profile-actions .btn {
        width: 100%;
    }

    .tab-btn {
        padding: 0.6rem 0.75rem;
        font-size: 0.8rem;
    }

    .tab-content {
        padding: 0.75rem;
    }

    .section-header {
        font-size: 1rem;
    }

    .military-grid {
        grid-template-columns: 1fr;
    }

    .military-card-label {
        font-size: 0.7rem;
    }

    .military-card-value {
        font-size: 1.1rem;
    }

    .rank-image-box {
        width: 50px;
        height: 50px;
    }

    .rank-image-box img {
        width: 40px;
        height: 40px;
    }

    .rank-name {
        font-size: 0.95rem;
    }

    .xp-section {
        padding: 0.75rem;
    }

    .xp-label, .xp-value {
        font-size: 0.8rem;
    }

    .skills-section {
        gap: 1rem;
    }

    .skill-category {
        padding: 0.75rem;
    }

    .skill-name, .skill-value {
        font-size: 0.8rem;
    }

    .achievement-card {
        padding: 0.75rem;
    }

    .achievement-icon {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
    }

    .achievement-name {
        font-size: 0.85rem;
    }

    .achievement-desc {
        font-size: 0.8rem;
    }

    .friends-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }

    .friend-card {
        padding: 0.5rem;
        flex-direction: column;
        text-align: center;
    }

    .friend-avatar {
        width: 50px;
        height: 50px;
    }

    .friend-name {
        font-size: 0.8rem;
    }

    .friend-level {
        font-size: 0.7rem;
    }

    .nft-slot-card {
        padding: 1rem;
    }

    .nft-slot-content {
        min-height: 200px;
    }

    .equipped-nft-image {
        width: 120px;
        height: 206px;
    }

    .equipped-nft-image:hover {
        transform: scale(1.3);
    }

    .avatar-wrapper {
        width: 120px;
        height: 120px;
    }

    .avatar-username {
        font-size: 1.1rem;
    }

    .avatar-level {
        font-size: 0.75rem;
    }

    .info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }

    .info-label {
        min-width: auto;
        font-size: 0.75rem;
    }

    .info-value {
        font-size: 0.85rem;
    }
}

@media (max-width: 360px) {
    .profile-title h1 {
        font-size: 1.1rem;
    }

    .tab-btn {
        padding: 0.5rem 0.6rem;
        font-size: 0.75rem;
    }

    .tab-btn i {
        display: none;
    }

    .military-card-value {
        font-size: 1rem;
    }

    .friends-grid {
        grid-template-columns: 1fr;
    }

    .friend-card {
        flex-direction: row;
        text-align: left;
    }

    .avatar-wrapper {
        width: 100px;
        height: 100px;
    }
}
</style>
{% endblock %}

{% block main_layout %}
{% include '_dashboard_wrapper.html' %}

<div class="profile-layout">
    <!-- Left Sidebar -->
    <div class="profile-sidebar">
        <!-- Avatar Card -->
        <div class="avatar-card">
            <div class="avatar-wrapper">
                <img src="{{ avatar_url if avatar_url else url_for('static', filename='images/default_avatar_placeholder.png') }}"
                     alt="{{ user.username }}'s Avatar"
                     class="avatar-image">
                <div class="online-indicator {{ 'online' if is_online else 'offline' }}" title="{{ 'Online' if is_online else 'Offline' }}"></div>
            </div>
            <div class="avatar-username">{{ user.username }}</div>
            <div class="avatar-level">Level {{ user.level }}</div>
            <div class="online-status-text {{ 'online' if is_online else 'offline' }}">
                {% if is_online %}
                    <i class="fas fa-circle" style="font-size: 0.5rem;"></i> Online now
                {% else %}
                    {% if user.last_seen %}
                        Last seen {{ user.last_seen | timesince }}
                    {% else %}
                        Offline
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Info Card -->
        <div class="info-card">
            <div class="info-card-header">Location</div>
            <div class="info-row">
                <span class="info-label">Region:</span>
                <span class="info-value">
                    {% if user.current_region %}
                        {% set owner_country = user.current_region.current_owner %}
                        {% if owner_country and owner_country.flag_code %}
                        <img src="{{ url_for('static', filename='images/country-flags/' + owner_country.flag_code + '.png') }}" class="flag-icon" alt="">
                        {% endif %}
                        <a href="{{ url_for('main.region', slug=user.current_region.slug) }}">{{ user.current_region.name }}</a>
                    {% else %}
                        <span style="opacity: 0.5;">Unknown</span>
                    {% endif %}
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Citizenship:</span>
                <span class="info-value">
                    {% if user.citizenship %}
                        {% if user.citizenship.flag_code %}
                        <img src="{{ url_for('static', filename='images/country-flags/' + user.citizenship.flag_code + '.png') }}" class="flag-icon" alt="">
                        {% endif %}
                        <a href="{{ url_for('main.country', slug=user.citizenship.slug) }}">{{ user.citizenship.name }}</a>
                    {% else %}
                        <span style="opacity: 0.5;">N/A</span>
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Personal Info Card -->
        <div class="info-card">
            <div class="info-card-header">Personal Info</div>
            <div class="info-row">
                <span class="info-label">Birthday:</span>
                <span class="info-value">
                    {% if user.birthday %}
                        {{ user.birthday.strftime('%b %d, %Y') }}
                    {% else %}
                        <span style="opacity: 0.5;">N/A</span>
                    {% endif %}
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Joined:</span>
                <span class="info-value">
                    {% if user.created_at %}
                        {{ user.created_at.strftime('%b %d, %Y') }}
                    {% else %}
                        <span style="opacity: 0.5;">N/A</span>
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Party Card -->
        {% if user.party %}
        <div class="party-card">
            <div class="info-card-header">Political Party</div>
            <div class="party-header">
                <i class="fas fa-landmark"></i>
                <a href="{{ url_for('party.detail', party_id=user.party.id) }}" class="party-name">{{ user.party.name }}</a>
            </div>
            <div class="party-role">{{ user.party_role.value if user.party_role else 'Member' }}</div>
        </div>
        {% endif %}

        <!-- Military Unit Card -->
        {% if user.military_unit %}
        <div class="mu-card">
            <div class="info-card-header">Military Unit</div>
            <div class="party-header">
                <i class="fas fa-shield-alt"></i>
                <a href="{{ url_for('military_unit.detail', unit_id=user.military_unit.id) }}" class="party-name">{{ user.military_unit.name }}</a>
            </div>
            <div class="party-role">{{ user.military_unit_role.value if user.military_unit_role else 'Soldier' }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="profile-main">
        <!-- Profile Header Bar -->
        <div class="profile-header-bar">
            <div class="profile-title">
                <span class="level-badge">{{ user.level }}</span>
                <h1>{{ user.username }} <small style="font-size: 0.5em; opacity: 0.5;">#{{ user.id }}</small></h1>
            </div>
            <div class="profile-actions">
                {% if current_user.is_authenticated and current_user.id != user.id %}
                    <a href="{{ url_for('main.message_thread', user_id=user.id) }}" class="btn btn-primary">
                        <i class="fas fa-envelope me-1"></i>Message
                    </a>
                    {% if friendship_status == 'friends' %}
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#unfriendModal">
                            <i class="fas fa-user-minus me-1"></i>Unfriend
                        </button>
                    {% elif friendship_status == 'request_sent' %}
                        <form action="{{ url_for('friendship.cancel_request', friendship_id=friendship_id) }}" method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-times me-1"></i>Cancel Request
                            </button>
                        </form>
                    {% elif friendship_status == 'request_received' %}
                        <form action="{{ url_for('friendship.accept_request', friendship_id=friendship_id) }}" method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check me-1"></i>Accept
                            </button>
                        </form>
                        <form action="{{ url_for('friendship.deny_request', friendship_id=friendship_id) }}" method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="fas fa-times me-1"></i>Deny
                            </button>
                        </form>
                    {% else %}
                        <form action="{{ url_for('friendship.send_request', user_id=user.id) }}" method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-user-plus me-1"></i>Add Friend
                            </button>
                        </form>
                    {% endif %}
                {% endif %}
                {% if current_user.is_authenticated and current_user.id == user.id %}
                    <a href="{{ url_for('main.edit_profile') }}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="profile-tabs">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('profile')">
                    <i class="fas fa-user me-1"></i>Profile
                </button>
                <button class="tab-btn" onclick="switchTab('achievements')">
                    <i class="fas fa-trophy me-1"></i>Achievements
                </button>
                <button class="tab-btn" onclick="switchTab('friends')">
                    <i class="fas fa-users me-1"></i>Friends ({{ friends_list|length }})
                </button>
                {% if is_own_profile %}
                <button class="tab-btn" onclick="switchTab('nfts')">
                    <i class="fas fa-gem me-1"></i>NFT Slots
                </button>
                {% endif %}
            </div>

            <div class="tab-content">
                <!-- Profile Tab -->
                <div id="profile-tab" class="tab-pane active">
                    {% if user.description %}
                    <div class="about-section">
                        <div class="section-header"><i class="fas fa-quote-left me-2"></i>About Me</div>
                        <p class="about-text">{{ user.description }}</p>
                    </div>
                    {% endif %}

                    <!-- Military Attributes -->
                    <div class="section-header"><i class="fas fa-medal me-2"></i>Military Attributes</div>
                    {% set rank_progress = user.get_rank_progress() %}
                    <div class="military-grid">
                        <div class="military-card">
                            <div class="military-card-label">Experience</div>
                            <div class="military-card-value">{{ user.experience|int }} XP</div>
                        </div>
                        <div class="military-card">
                            <div class="military-card-label">Total Military Skill</div>
                            <div class="military-card-value">{{ (user.skill_infantry + user.skill_armoured + user.skill_aviation)|round(2) }}</div>
                        </div>
                        <div class="military-card">
                            <div class="military-card-label">Military Rank</div>
                            <div class="military-rank-display">
                                <div class="rank-image-box">
                                    <img src="{{ url_for('static', filename='images/MilitaryRanks/' ~ rank_progress.current_rank.id ~ '.' ~ rank_progress.current_rank.name ~ '.webp') }}"
                                         alt="{{ rank_progress.current_rank.name }}"
                                         onerror="this.style.display='none'">
                                </div>
                                <div>
                                    <div class="rank-name">{{ rank_progress.current_rank.name }}</div>
                                    <div class="rank-bonus">+{{ rank_progress.current_rank.damage_bonus }}% Damage</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- XP Progress -->
                    {% set xp_needed_inc = user.xp_increment_for_current_level %}
                    {% set xp_progress = user.xp_progress_in_current_level %}
                    {% set progress_percent = (xp_progress / xp_needed_inc * 100) if xp_needed_inc > 0 else 0 %}
                    <div class="xp-section">
                        <div class="xp-header">
                            <span class="xp-label">Level Progress</span>
                            <span class="xp-value">{{ xp_progress|int }} / {{ xp_needed_inc|int }} to Level {{ user.level + 1 }}</span>
                        </div>
                        <div class="xp-bar">
                            <div class="xp-bar-fill" style="width: {{ progress_percent }}%;"></div>
                        </div>
                    </div>

                    {% if rank_progress.next_rank %}
                    <div class="xp-section">
                        <div class="xp-header">
                            <span class="xp-label">Rank Progress</span>
                            <span class="xp-value">{{ rank_progress.current_xp|int }} / {{ rank_progress.xp_needed|int }} to {{ rank_progress.next_rank.name }}</span>
                        </div>
                        <div class="xp-bar">
                            <div class="xp-bar-fill rank" style="width: {{ rank_progress.progress_percent }}%;"></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Skills -->
                    <div class="section-header" style="margin-top: 1.5rem;"><i class="fas fa-chart-bar me-2"></i>Skills</div>
                    <div class="skills-section">
                        <div class="skill-category">
                            <div class="skill-category-header military">
                                <i class="fas fa-crosshairs me-2"></i>Military Skills
                            </div>
                            <div class="skill-row">
                                <img src="{{ url_for('static', filename='images/skills/infantry.webp') }}" alt="Infantry" class="skill-icon">
                                <span class="skill-name">Infantry</span>
                                <span class="skill-value military">{{ user.skill_infantry|round(2) }}</span>
                            </div>
                            <div class="skill-row">
                                <img src="{{ url_for('static', filename='images/skills/armoured.webp') }}" alt="Armoured" class="skill-icon">
                                <span class="skill-name">Armoured</span>
                                <span class="skill-value military">{{ user.skill_armoured|round(2) }}</span>
                            </div>
                            <div class="skill-row">
                                <img src="{{ url_for('static', filename='images/skills/heli.webp') }}" alt="Aviation" class="skill-icon">
                                <span class="skill-name">Aviation</span>
                                <span class="skill-value military">{{ user.skill_aviation|round(2) }}</span>
                            </div>
                        </div>
                        <div class="skill-category">
                            <div class="skill-category-header work">
                                <i class="fas fa-briefcase me-2"></i>Work Skills
                            </div>
                            <div class="skill-row">
                                <img src="{{ url_for('static', filename='images/skills/resource_extraction.webp') }}" alt="Resource Extraction" class="skill-icon">
                                <span class="skill-name">Resource Extraction</span>
                                <span class="skill-value work">{{ user.skill_resource_extraction|round(2) }}</span>
                            </div>
                            <div class="skill-row">
                                <img src="{{ url_for('static', filename='images/skills/manufacture.webp') }}" alt="Manufacture" class="skill-icon">
                                <span class="skill-name">Manufacture</span>
                                <span class="skill-value work">{{ user.skill_manufacture|round(2) }}</span>
                            </div>
                            <div class="skill-row">
                                <img src="{{ url_for('static', filename='images/skills/construction.webp') }}" alt="Construction" class="skill-icon">
                                <span class="skill-name">Construction</span>
                                <span class="skill-value work">{{ user.skill_construction|round(2) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Achievements Tab -->
                <div id="achievements-tab" class="tab-pane">
                    {# Achievement code to image filename mapping #}
                    {% set achievement_images = {
                        'hard_worker_7': 'dedicated_worker',
                        'hard_worker_30': 'hard_worker',
                        'hard_worker_100': 'work_legend',
                        'training_hard_7': 'fitness_enthusiast',
                        'training_hard_30': 'training_hard',
                        'training_hard_100': 'training_master',
                        'quick_learner_7': 'student',
                        'quick_learner_30': 'quick_learner',
                        'quick_learner_100': 'scholar',
                        'entrepreneur_1': 'business_owner',
                        'entrepreneur_5': 'entrepreneur',
                        'entrepreneur_10': 'business_tycoon',
                        'explorer_all_countries': 'explorer',
                        'recruiter_10': 'recruiter',
                        'recruiter_100': 'master_recruiter',
                        'recruiter_1000': 'legendary_recruiter',
                        'social_butterfly_10': 'social_butterfly',
                        'social_butterfly_50': 'popular',
                        'battle_hero_10': 'rising_warrior',
                        'battle_hero_100': 'war_legend',
                        'freedom_fighter': 'freedom_fighter',
                        'elected_president': 'mr_president',
                        'elected_congress': 'congressman',
                        'rising_publisher': 'rising_publisher',
                        'popular_publisher': 'popular_publisher'
                    } %}
                    {% if user.achievements_earned %}
                        <div class="achievements-grid">
                            {% for user_achievement in user.achievements_earned %}
                            {% set img_name = achievement_images.get(user_achievement.achievement.code, user_achievement.achievement.code) %}
                            <div class="achievement-card">
                                <div class="achievement-image">
                                    <img src="{{ url_for('static', filename='images/achievements/' ~ img_name ~ '.webp') }}"
                                         alt="{{ user_achievement.achievement.name }}"
                                         onerror="this.parentElement.innerHTML='<i class=\'fas fa-trophy\' style=\'font-size:2rem;color:#ffd700;display:flex;align-items:center;justify-content:center;height:100%\'></i>'">
                                </div>
                                <div class="achievement-name">{{ user_achievement.achievement.name }}</div>
                                <div class="achievement-category">{{ user_achievement.achievement.category }}</div>
                                <div class="achievement-footer">
                                    <div class="achievement-reward">
                                        <i class="fas fa-coins me-1"></i>+{{ user_achievement.gold_awarded }} Gold
                                    </div>
                                    <div class="achievement-date">
                                        {{ user_achievement.unlocked_at.strftime('%b %d, %Y') }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-trophy"></i>
                            <p>No achievements unlocked yet</p>
                            <small>Complete activities to earn achievements and gold rewards!</small>
                        </div>
                    {% endif %}
                </div>

                <!-- Friends Tab -->
                <div id="friends-tab" class="tab-pane">
                    {% if friends_list %}
                        <div class="friends-grid">
                            {% for friend in friends_list %}
                            <a href="{{ url_for('main.view_profile', username=friend.username or friend.wallet_address) }}" class="friend-card">
                                {% if friend.avatar %}
                                <img src="{{ url_for('static', filename='uploads/avatars/' ~ friend.id ~ '.png') }}"
                                     alt="{{ friend.username }}'s Avatar"
                                     class="friend-avatar"
                                     onerror="this.src='{{ url_for('static', filename='images/default_avatar_placeholder.png') }}'">
                                {% else %}
                                <img src="{{ url_for('static', filename='images/default_avatar_placeholder.png') }}"
                                     alt="{{ friend.username }}'s Avatar"
                                     class="friend-avatar">
                                {% endif %}
                                <div>
                                    <div class="friend-name">{{ friend.username or friend.wallet_address[:10] }}</div>
                                    <div class="friend-level">Level {{ friend.level }}</div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No friends yet</p>
                            <small>Add friends to see them here!</small>
                        </div>
                    {% endif %}
                </div>

                <!-- NFT Slots Tab (Own Profile Only) -->
                {% if is_own_profile %}
                <div id="nfts-tab" class="tab-pane">
                    <p class="text-muted small mb-3">
                        <i class="fas fa-info-circle me-1"></i>Equip player NFTs to gain bonuses. Each slot has a 24-hour cooldown after any change.
                    </p>
                    <div class="nft-slots-grid">
                        {% for slot_num in [1, 2, 3] %}
                        <div class="nft-slot-card" id="player-slot-{{ slot_num }}">
                            <div class="nft-slot-header">
                                <span class="nft-slot-number">Slot {{ slot_num }}</span>
                                <span class="nft-slot-cooldown" id="cooldown-{{ slot_num }}" style="display: none;"></span>
                            </div>
                            <div class="nft-slot-content" id="slot-{{ slot_num }}-content">
                                <div class="text-center py-4">
                                    <i class="fas fa-plus-circle fa-3x text-muted mb-2"></i>
                                    <p class="text-muted mb-0">Empty Slot</p>
                                </div>
                            </div>
                            <div class="nft-slot-actions">
                                <button class="btn btn-primary btn-sm w-100" onclick="openEquipModal({{ slot_num }})" id="equip-btn-{{ slot_num }}">
                                    <i class="fas fa-plus me-1"></i>Equip NFT
                                </button>
                                <button class="btn btn-danger btn-sm w-100" onclick="unequipNFT({{ slot_num }})" id="unequip-btn-{{ slot_num }}" style="display: none;">
                                    <i class="fas fa-minus me-1"></i>Unequip
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Unfriend Modal -->
{% if current_user.is_authenticated and current_user.id != user.id and friendship_status == 'friends' %}
<div class="modal fade" id="unfriendModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(239, 68, 68, 0.3);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(239, 68, 68, 0.2);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-user-minus me-2 text-danger"></i>Unfriend {{ user.username }}?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-white">
                <p>Are you sure you want to remove {{ user.username }} from your friends list?</p>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(239, 68, 68, 0.2);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('friendship.unfriend', user_id=user.id) }}" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-user-minus me-1"></i>Unfriend
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- NFT Equip Modal -->
{% if is_own_profile %}
<div class="modal fade" id="equipNFTModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(34, 197, 94, 0.3);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(34, 197, 94, 0.2);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-gem me-2 text-success"></i>Select NFT for Slot <span id="modal-slot-number"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="nft-selection-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading NFTs...</p>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(34, 197, 94, 0.2);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-equip-btn" onclick="confirmEquip()" disabled>
                    <i class="fas fa-check me-1"></i>Equip Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });

    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.closest('.tab-btn').classList.add('active');

    // Load NFT slots if switching to NFTs tab
    if (tabName === 'nfts') {
        loadPlayerNFTSlots();
    }
}

{% if is_own_profile %}
// NFT Management Functions
let selectedNFTId = null;
let currentSlot = null;

// Bonus values by tier for each category (matches nft_config.py)
const PLAYER_NFT_BONUSES = {
    'combat_boost': { 1: 5, 2: 15, 3: 25, 4: 40, 5: 60 },
    'energy_regen': { 1: 2, 2: 5, 3: 10, 4: 20, 5: 35 },
    'wellness_regen': { 1: 2, 2: 5, 3: 10, 4: 20, 5: 35 },
    'military_tutor': { 1: 20, 2: 40, 3: 60, 4: 80, 5: 100 },
    'travel_discount': { 1: 20, 2: 40, 3: 60, 4: 80, 5: 100 },
    'storage_increase': { 1: 1000, 2: 2500, 3: 5000, 4: 10000, 5: 25000 }
};

function getCalculatedBonus(category, tier) {
    const categoryBonuses = PLAYER_NFT_BONUSES[category];
    if (categoryBonuses && categoryBonuses[tier]) {
        return categoryBonuses[tier];
    }
    return 0;
}

function getBonusDisplay(nft) {
    // Use bonus_formatted from API if available (includes proper formatting for each category)
    if (nft.bonus_formatted) {
        return nft.bonus_formatted;
    }

    // Fallback: Use stored bonus_value if available and non-zero, otherwise calculate from tier
    let bonus = nft.bonus_value;
    if (!bonus || bonus === 0) {
        bonus = getCalculatedBonus(nft.category, nft.tier);
    }

    if (nft.category === 'energy_regen') {
        return `+${bonus} energy/hr`;
    } else if (nft.category === 'wellness_regen') {
        return `+${bonus} wellness/hr`;
    } else if (nft.category === 'military_tutor') {
        return `+${bonus}%`;
    } else if (nft.category === 'travel_discount') {
        return bonus >= 100 ? 'Free travel' : `-${bonus}%`;
    } else if (nft.category === 'storage_increase') {
        return `+${bonus.toLocaleString()} storage`;
    } else if (nft.category === 'combat_boost') {
        return `+${bonus}%`;
    } else if (nft.category === 'material_efficiency' || nft.category === 'upgrade_discount' ||
               nft.category === 'speed_boost' || nft.category === 'tax_breaks') {
        return `-${bonus}%`;
    } else if (nft.category === 'android_worker') {
        return `Skill Level ${bonus}`;
    } else {
        return `+${bonus}%`;
    }
}

function getShortBonusDisplay(nft) {
    // Use bonus_formatted from API if available (includes proper formatting for each category)
    if (nft.bonus_formatted) {
        return nft.bonus_formatted;
    }

    // Fallback: Short version for badge display
    let bonus = nft.bonus_value;
    if (!bonus || bonus === 0) {
        bonus = getCalculatedBonus(nft.category, nft.tier);
    }

    if (nft.category === 'energy_regen') {
        return `+${bonus}/hr`;
    } else if (nft.category === 'wellness_regen') {
        return `+${bonus}/hr`;
    } else if (nft.category === 'storage_increase') {
        return `+${bonus.toLocaleString()}`;
    } else if (nft.category === 'android_worker') {
        return `Lvl ${bonus}`;
    } else if (nft.category === 'material_efficiency' || nft.category === 'upgrade_discount' ||
               nft.category === 'speed_boost' || nft.category === 'tax_breaks' || nft.category === 'travel_discount') {
        return `-${bonus}%`;
    } else {
        return `+${bonus}%`;
    }
}

function loadPlayerNFTSlots() {
    fetch('/api/nft/slots/profile')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSlotDisplays(data.slots);
            }
        })
        .catch(error => console.error('Error loading NFT slots:', error));
}

function updateSlotDisplays(slots) {
    for (let slotNum = 1; slotNum <= 3; slotNum++) {
        const nft = slots[`slot_${slotNum}_nft`];
        const contentDiv = document.getElementById(`slot-${slotNum}-content`);
        const equipBtn = document.getElementById(`equip-btn-${slotNum}`);
        const unequipBtn = document.getElementById(`unequip-btn-${slotNum}`);
        const cooldownSpan = document.getElementById(`cooldown-${slotNum}`);

        // Hide cooldown for now (not returned from API yet)
        cooldownSpan.style.display = 'none';

        if (nft) {
            let bonusDisplay = getBonusDisplay(nft);

            contentDiv.innerHTML = `
                <div class="equipped-nft-card">
                    ${nft.image_url ? `<img src="${nft.image_url}" alt="${nft.name}" class="equipped-nft-image" onerror="this.src='/static/images/nft_placeholder.png'">` : ''}
                    <div class="equipped-nft-info">
                        <div class="equipped-nft-name">${nft.name}</div>
                        <div class="equipped-nft-bonus"><i class="fas fa-bolt me-1"></i>${bonusDisplay}</div>
                    </div>
                </div>
            `;
            equipBtn.style.display = 'none';
            unequipBtn.style.display = 'block';
        } else {
            contentDiv.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-plus-circle fa-3x text-muted mb-2"></i>
                    <p class="text-muted mb-0">Empty Slot</p>
                </div>
            `;
            equipBtn.style.display = 'block';
            unequipBtn.style.display = 'none';
        }
    }
}

function openEquipModal(slotNum) {
    currentSlot = slotNum;
    selectedNFTId = null;
    document.getElementById('modal-slot-number').textContent = slotNum;
    document.getElementById('confirm-equip-btn').disabled = true;

    const modal = new bootstrap.Modal(document.getElementById('equipNFTModal'));
    modal.show();

    // Load available NFTs
    const container = document.getElementById('nft-selection-container');
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-success"></div><p class="text-muted mt-2">Loading NFTs...</p></div>';

    fetch('/api/nft/inventory?type=player')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.nfts) {
                const playerNFTs = data.nfts.filter(nft => !nft.is_equipped);

                if (playerNFTs.length === 0) {
                    container.innerHTML = `<div class="empty-state"><i class="fas fa-gem"></i><p>No player NFTs available</p><small>All your player NFTs are already equipped or you don't have any.</small></div>`;
                    return;
                }

                container.innerHTML = '<div class="nft-select-grid">' + playerNFTs.map(nft => {
                    let bonusDisplay = getBonusDisplay(nft);
                    let shortBonus = getShortBonusDisplay(nft);

                    return `
                    <div class="nft-select-card" onclick="selectNFTToEquip(${nft.id})" id="nft-option-${nft.id}">
                        <div class="nft-select-inner">
                            <div class="nft-select-image">
                                ${nft.image_url ? `<img src="${nft.image_url}" alt="${nft.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="nft-placeholder" style="display:none"><i class="fas fa-gem"></i></div>` : '<div class="nft-placeholder"><i class="fas fa-gem"></i></div>'}
                            </div>
                            <div class="nft-select-header">
                                <span class="nft-tier-badge tier-${nft.tier}">Q${nft.tier}</span>
                                <span class="nft-bonus-badge">${shortBonus}</span>
                            </div>
                            <div class="nft-select-name">${nft.name.split(' - ')[0]}</div>
                        </div>
                    </div>
                    `;
                }).join('') + '</div>';
            }
        })
        .catch(error => {
            container.innerHTML = '<div class="text-center text-danger py-4">Error loading NFTs</div>';
        });
}

function selectNFTToEquip(nftId) {
    // Remove selected class from all cards
    document.querySelectorAll('.nft-select-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Add selected class to clicked card
    const selectedCard = document.getElementById(`nft-option-${nftId}`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }

    selectedNFTId = nftId;
    document.getElementById('confirm-equip-btn').disabled = false;
}

function confirmEquip() {
    if (!selectedNFTId || !currentSlot) return;

    fetch('/api/nft/equip/profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            nft_id: selectedNFTId,
            slot: currentSlot
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('equipNFTModal')).hide();
            loadPlayerNFTSlots();
        } else {
            alert(data.error || 'Failed to equip NFT');
        }
    })
    .catch(error => {
        alert('Error equipping NFT');
    });
}

function unequipNFT(slotNum) {
    if (!confirm('Are you sure you want to unequip this NFT?')) return;

    fetch('/api/nft/unequip/profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ slot: slotNum })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadPlayerNFTSlots();
        } else {
            alert(data.error || 'Failed to unequip NFT');
        }
    })
    .catch(error => {
        alert('Error unequipping NFT');
    });
}

// Load NFT slots on page load if on NFTs tab
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('nfts-tab') && document.getElementById('nfts-tab').classList.contains('active')) {
        loadPlayerNFTSlots();
    }
});
{% endif %}
</script>

{% endblock main_layout %}

{% block scripts %}
{{ super() }}
{% endblock %}
