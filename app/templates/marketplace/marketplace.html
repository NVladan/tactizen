{% extends "layouts/base.html" %}

{% block title %}NFT Marketplace - Tactizen{% endblock %}

{% block head_extra %}
{# Import shared dashboard styles #}
{% include '_dashboard_styles.html' %}
<style>
    .nft-header {
        background: linear-gradient(rgba(15, 20, 25, 0.7), rgba(15, 20, 25, 0.7)), url('{{ url_for("static", filename="images/buildings/nftmarket.png") }}');
        background-size: cover;
        background-position: center;
        border-radius: 16px;
        padding: 4rem 2rem;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        border: 1px solid rgba(34, 197, 94, 0.2);
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
</style>
{% endblock %}

{% block main_layout %}
{% include '_dashboard_wrapper.html' %}
    <div class="main-container">
        <!-- Tab Navigation Header -->
        <ul class="nav nav-tabs mb-4" id="marketTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link" href="{% if current_user.citizenship %}{{ url_for('main.marketplace', country_slug=current_user.citizenship.slug) }}{% else %}#{% endif %}"><i class="fas fa-store me-1"></i>Marketplace</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('company.job_market') }}"><i class="fas fa-briefcase me-1"></i>Job Market</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('main.currency_market_default') }}"><i class="fas fa-money-bill-wave me-1"></i>Currency Market</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('main.zen_market') }}"><i class="fas fa-coins me-1"></i>Zen Market</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link active" href="{{ url_for('marketplace.marketplace_page') }}"><i class="fas fa-gem me-1"></i>NFT Market</a>
          </li>
        </ul>

        <!-- Header -->
        <div class="nft-header text-center">
            <h2 class="mb-3">NFT Market</h2>
            <p class="text-muted mb-0">Buy and sell NFTs on the blockchain.</p>
        </div>

        <div class="container-fluid">
            <!-- Header Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-gem me-2 text-primary"></i>NFT Marketplace
                            </h2>
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle me-1"></i>
                                Marketplace fee: <strong id="marketplaceFee" class="text-warning">5%</strong>
                                <span class="ms-2">â€¢ NFTs held in secure escrow</span>
                            </p>
                        </div>
                <div>
                    <button class="btn btn-outline-success me-2" id="myListingsBtn">
                        <i class="fas fa-list me-1"></i> My Listings
                    </button>
                    <button class="btn btn-primary" id="myNFTsBtn">
                        <i class="fas fa-plus me-1"></i> List NFT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card sticky-top" style="top: 80px; background: #1a1f2e;">
                <div class="card-header border-bottom border-secondary">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">NFT Type</label>
                        <select class="form-select" id="filterType">
                            <option value="">All Types</option>
                            <option value="player">Player NFTs</option>
                            <option value="company">Company NFTs</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Category</label>
                        <select class="form-select" id="filterCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Quality Range</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="filterMinTier">
                                    <option value="">Min</option>
                                    <option value="1">Q1</option>
                                    <option value="2">Q2</option>
                                    <option value="3">Q3</option>
                                    <option value="4">Q4</option>
                                    <option value="5">Q5</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="filterMaxTier">
                                    <option value="">Max</option>
                                    <option value="1">Q1</option>
                                    <option value="2">Q2</option>
                                    <option value="3">Q3</option>
                                    <option value="4">Q4</option>
                                    <option value="5">Q5</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Price Range (ZEN)</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" id="filterMinPrice" placeholder="Min">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" id="filterMaxPrice" placeholder="Max">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Sort By</label>
                        <select class="form-select" id="sortBy">
                            <option value="listed_at">Newest First</option>
                            <option value="price_zen">Price: Low to High</option>
                            <option value="tier">Quality: High to Low</option>
                        </select>
                    </div>

                    <button class="btn btn-primary w-100 mb-2" id="applyFiltersBtn">
                        <i class="fas fa-search me-1"></i> Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary w-100" id="clearFiltersBtn">
                        <i class="fas fa-times me-1"></i> Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-9">
            <!-- Scrollable Container -->
            <div class="marketplace-listings-scroll" style="max-height: calc(100vh - 200px); overflow-y: auto; overflow-x: hidden; padding-right: 10px;">
                <!-- Listings -->
                <div id="loadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-3">Loading marketplace...</p>
                </div>

                <div id="listingsContainer" class="row g-4" style="display: none;"></div>

                <div id="noListings" class="text-center py-5" style="display: none;">
                    <div class="mb-4">
                        <i class="fas fa-store-slash fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-2">No NFTs Available</h4>
                    <p class="text-muted">No listings match your current filters.</p>
                    <button class="btn btn-outline-primary mt-3" id="clearFiltersBtn2">
                        <i class="fas fa-times me-1"></i> Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- List NFT Modal -->
<div class="modal fade" id="listNFTModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(34, 197, 94, 0.3);">
            <div class="modal-header border-bottom border-secondary">
                <div>
                    <h5 class="modal-title mb-1"><i class="fas fa-tag me-2"></i>List NFT for Sale</h5>
                    <p class="text-muted small mb-0">Select an NFT to list on the marketplace</p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="myNFTsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                    <p class="text-muted mt-3">Loading your NFTs...</p>
                </div>
                <div id="myNFTsContainer" style="display: none;">
                    <div class="alert alert-warning mb-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> Only unequipped NFTs can be listed. Your NFT will be transferred to the marketplace contract as escrow.
                    </div>
                    <div id="myNFTsList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"></div>
                    <div id="myNFTsEmpty" class="text-center py-5" style="display: none;">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No NFTs Available</h5>
                        <p class="text-muted">All your NFTs are currently equipped or already listed.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
</div>

<!-- Set Price Modal -->
<div class="modal fade" id="setPriceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(34, 197, 94, 0.3);">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title"><i class="fas fa-dollar-sign me-2"></i>Set Price</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Important:</strong> You'll need to approve 2 transactions:
                    <ol class="mb-0 mt-2 ps-3">
                        <li>Approve the NFT transfer</li>
                        <li>List the NFT on marketplace</li>
                    </ol>
                </div>
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Gas Fee Tip:</strong> MetaMask may suggest a high gas fee. Click "Edit" on the gas fee and select "Aggressive" or "Market" for lower fees on Base Sepolia testnet.
                </div>
                <div class="mb-3">
                    <label class="form-label">Price in ZEN</label>
                    <input type="number" class="form-control" id="listingPrice" placeholder="100" min="0.01" step="0.01">
                </div>
                <div id="feeCalculation" class="alert alert-info" style="display: none;">
                    <h6>Breakdown:</h6>
                    <p class="mb-1">Listing Price: <strong id="displayPrice">0</strong> ZEN</p>
                    <p class="mb-1">Marketplace Fee (<span id="feePercent">5</span>%): <strong id="displayFee">0</strong> ZEN</p>
                    <hr>
                    <p class="mb-0"><strong>You'll receive: <span id="displaySellerAmount">0</span> ZEN</strong></p>
                </div>
                <input type="hidden" id="selectedNFTId">
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmListingBtn">
                    <i class="fas fa-check"></i> List NFT
                </button>
            </div>
        </div>
    </div>
</div>

<!-- My Listings Modal -->
<div class="modal fade" id="myListingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(34, 197, 94, 0.3);">
            <div class="modal-header border-bottom border-secondary">
                <div>
                    <h5 class="modal-title mb-1"><i class="fas fa-list me-2"></i>My Active Listings</h5>
                    <p class="text-muted small mb-0">Manage your NFTs currently listed on the marketplace</p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="myListingsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                    <p class="text-muted mt-3">Loading your listings...</p>
                </div>
                <div id="myListingsContainer" style="display: none;"></div>
                <div id="myListingsEmpty" class="text-center py-5" style="display: none;">
                    <i class="fas fa-store-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Active Listings</h5>
                    <p class="text-muted">You don't have any NFTs listed on the marketplace.</p>
                    <button class="btn btn-primary mt-3" data-bs-dismiss="modal" id="listNFTFromEmpty">
                        <i class="fas fa-plus me-1"></i> List an NFT
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(34, 197, 94, 0.5);">
            <div class="modal-header border-bottom border-success">
                <h5 class="modal-title"><i class="fas fa-check-circle text-success me-2"></i>Success</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="successMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(239, 68, 68, 0.5);">
            <div class="modal-header border-bottom border-danger">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>Error</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #1a1f2e; border: 1px solid rgba(59, 130, 246, 0.5);">
            <div class="modal-header border-bottom border-info">
                <h5 class="modal-title"><i class="fas fa-info-circle text-info me-2"></i>Information</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="infoMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<style>
.nft-card {
    background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    transition: all 0.3s ease;
    overflow: visible;
    position: relative;
}

.nft-card-image {
    cursor: pointer;
    position: relative;
}

.nft-card-image:hover {
    transform: scale(2);
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), 0 0 20px rgba(34, 197, 94, 0.4);
    transition: transform 0.2s ease;
}

.nft-tier-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: bold;
    font-size: 0.9rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.tier-1 { background: linear-gradient(135deg, #6b7280, #9ca3af); }
.tier-2 { background: linear-gradient(135deg, #10b981, #34d399); }
.tier-3 { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
.tier-4 { background: linear-gradient(135deg, #a855f7, #c084fc); }
.tier-5 { background: linear-gradient(135deg, #f59e0b, #fbbf24); }

.nft-type-icon {
    font-size: 4rem;
    opacity: 0.1;
    position: absolute;
    bottom: 10px;
    left: 10px;
}

.btn-buy {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    transition: all 0.3s ease;
}

.btn-buy:hover {
    background: linear-gradient(135deg, #16a34a, #15803d);
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
}

.btn-cancel {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border: none;
    transition: all 0.3s ease;
}

.btn-cancel:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
}

/* Custom Scrollbar */
.marketplace-listings-scroll::-webkit-scrollbar {
    width: 8px;
}

.marketplace-listings-scroll::-webkit-scrollbar-track {
    background: rgba(15, 20, 25, 0.5);
    border-radius: 10px;
}

.marketplace-listings-scroll::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.3);
    border-radius: 10px;
    transition: all 0.3s ease;
}

.marketplace-listings-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 197, 94, 0.5);
}

/* Firefox scrollbar */
.marketplace-listings-scroll {
    scrollbar-width: thin;
    scrollbar-color: rgba(34, 197, 94, 0.3) rgba(15, 20, 25, 0.5);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
<script src="{{ url_for('static', filename='js/marketplace.js') }}"></script>
{% endblock %}
